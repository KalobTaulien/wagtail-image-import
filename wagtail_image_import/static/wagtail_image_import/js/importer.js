!function(e){var t={};function n(l){if(t[l])return t[l].exports;var a=t[l]={i:l,l:!1,exports:{}};return e[l].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,l){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:l})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var l=Object.create(null);if(n.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(l,a,function(t){return e[t]}.bind(null,a));return l},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t){const n=window.React,l=window.ReactDOM,a=window.wagtail.components.Icon;function r(e){const[t,l]=n.useState([]),[a,r]=n.useState(void 0),[c,d]=n.useState(void 0),[u,m]=n.useState(e.collections[0][0]);return t&&t.length?a?n.createElement(i,{imageImports:t.map(e=>{const t=e.id;return a[t],imageImport={drive_id:t,name:e.name,progress:0,action:a[t]||"keep",thumbnail:e.thumbnailLink,wagtail_id:"replace"==a[t]?c[t].wagtail_id:null}}).filter(e=>!("cancel"==e.action)),csrfToken:e.csrfToken,collection:u,tagitOpts:e.tagitOpts}):n.createElement(s,{imageData:t,duplicateReviewUrl:e.duplicateReviewUrl,onConfirmDuplicateActions:r,onGetDuplicateData:d}):n.createElement(n.Fragment,null,n.createElement(p,{appId:e.appId,pickerApiKey:e.pickerApiKey,clientId:e.clientId,scope:"https://www.googleapis.com/auth/documents.readonly https://www.googleapis.com/auth/drive.readonly",onGetImageData:l}),n.createElement(o,{collections:e.collections,selected:u,onChange:e=>{m(e.target.value)}}))}function o(e){return n.createElement("div",{class:"field nice-padding"},n.createElement("label",{for:"id_addimage_collection"},"Add to collection:"),n.createElement("div",{class:"field-content"},n.createElement("select",{id:"id_addimage_collection",name:"collection",value:e.selected,onChange:e.onChange},e.collections.map(e=>n.createElement("option",{value:e[0]},e[1])))))}function i(e){const[t,l]=n.useState(!1),[a,r]=n.useState(e.imageImports),o=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;function i(e,t,n){let l=[...a];l[n][e]=t,r(l)}function s(t,n){l(!0);var a=new XMLHttpRequest;a.addEventListener("load",r=>{i("progress",50,n),function(t,n,a){let r=new FormData;r.append("drive_id",n.drive_id),r.append("wagtail_id",n.wagtail_id),r.append("action",n.action),r.append("name",n.name),r.append("collection",e.collection),r.append("image_file",t);var o=new XMLHttpRequest;o.addEventListener("load",async e=>{l(!1);let t=await o.response;t=JSON.parse(t),t.error&&i("error",t.error,a),i("imported",!0,a),i("form",t.form,a),i("edit_action",t.edit_action,a),i("delete_action",t.delete_action,a),i("progress",100,a)}),o.addEventListener("error",async e=>{l(!1),i("error","Failed to upload to Wagtail",a)}),o.upload.addEventListener("progress",e=>{e.lengthComputable&&i("progress",Math.floor(50+100*e.loaded/(2*e.total)),a)}),o.open("POST",window.location),o.setRequestHeader("X-CSRFToken",e.csrfToken),o.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest"),o.send(r)}(new File([a.response],t.name),t,n)}),a.addEventListener("error",()=>{i("progress",0,n),l(!1),i("error","Failed to import from Google",n)}),a.addEventListener("progress",e=>{e.lengthComputable&&i("progress",Math.floor(100*e.loaded/(2*e.total)),n)}),a.open("GET","https://www.googleapis.com/drive/v3/files/"+t.drive_id+"?alt=media"),a.responseType="blob",a.setRequestHeader("Authorization","Bearer "+o),a.send()}n.useEffect(()=>{if(!t){const e=a.findIndex(e=>!e.error&&!e.imported),t=a[e];t&&s(t,e)}},[t]);const d=a.reduce((e,t)=>e+t.progress/a.length,0);return n.createElement("div",{class:"nice-padding"},n.createElement("h2",null,"Image import"),n.createElement("div",{id:"overall-progress","aria-valuenow":Math.floor(d),class:"progress progress-secondary active"},n.createElement("div",{class:"bar",style:{width:d+"%"}},Math.floor(d))),n.createElement("ul",{id:"upload-list",class:"upload-list multiple"},a.filter(e=>!e.finished).map((function(t,l){return n.createElement(c,{progress:t.progress,thumbnail:t.thumbnail,name:t.name,form:t.form,error:t.error,onFormResponseError:e=>{i("error",e.error,l),i("form",e.form,l),i("edit_action",e.edit_action,l),i("delete_action",e.delete_action,l)},onFormResponseSuccess:e=>{i("finished",!0,l),i("error",e.error,l),i("form",e.form,l),i("edit_action",e.edit_action,l),i("delete_action",e.delete_action,l)},onDeleteResponseLoad:e=>{i("finished",!0,l),i("error",e.error,l),i("form",e.form,l),i("edit_action",e.edit_action,l),i("delete_action",e.delete_action,l)},driveId:t.drive_id,editAction:t.edit_action,deleteAction:t.delete_action,csrfToken:e.csrfToken,tagitOpts:e.tagitOpts})}))))}function c(e){const t=n.useRef(null);return n.useLayoutEffect(()=>{if(t.current){const n=$(".tag_field input",t.current);if(n)return n.tagit(e.tagitOpts),()=>{n.tagit("destroy")}}},[e.form]),n.createElement("li",{class:"row upload-uploading"},n.createElement("div",{class:"left col3"},n.createElement("div",{class:"preview"},n.createElement("div",{class:"thumb icon icon-image hasthumb"},n.createElement("img",{src:e.thumbnail})),n.createElement("div",{class:"progress active"},n.createElement("div",{class:"bar",style:{width:e.progress+"%"}},e.progress,"%")))),n.createElement("div",{class:"right col9"},n.createElement("p",null,e.name),e.error,n.createElement("form",{method:"POST",enctype:"multipart/form-data",novalidate:!0,ref:t,onSubmit:t=>{t.preventDefault();var n=new XMLHttpRequest;n.addEventListener("load",async t=>{t.preventDefault(),res=await n.response,res=JSON.parse(res),res.error?e.onFormResponseError(res):e.onFormResponseSuccess(res)}),n.open("POST",e.editAction),n.setRequestHeader("X-CSRFToken",e.csrfToken),n.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest"),n.send(new FormData(t.target))}},n.createElement("ul",{class:"fields"},n.createElement("div",{dangerouslySetInnerHTML:{__html:e.form}}),n.createElement("li",null,n.createElement("input",{type:"hidden",name:"drive_id",value:e.driveId}),n.createElement("input",{type:"submit",value:"Update",class:"button"}),n.createElement("button",{class:"delete button button-secondary no",onClick:t=>{t.preventDefault();var n=new XMLHttpRequest;n.addEventListener("load",async t=>{t.preventDefault(),res=await n.response,res=JSON.parse(res),e.onDeleteResponseLoad(res)}),n.open("POST",e.editAction),n.setRequestHeader("X-CSRFToken",e.csrfToken),n.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest"),n.send()}},"Delete"))))))}function s(e){const[t,l]=n.useState({}),[a,r]=n.useState({});if(n.useEffect(()=>{const t=JSON.stringify(e.imageData);fetch(e.duplicateReviewUrl,{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:t}).then(t=>{t.ok?t.json().then(t=>{l(t),e.onGetDuplicateData(t);let n=Object.keys(t),a={};for(let e=0;e<n.length;e++)a[n[e]]="replace";r(a),0==n.length&&e.onConfirmDuplicateActions({})}):console.error(t)}).catch(e=>{console.error(e)})},[e.selectedImageData]),t&&Object.keys(t).length>0){let l=!0;getGlobalAction=()=>l?a[Object.keys(a)[0]]:null,setGlobalAction=e=>{let t={};const n=Object.keys(a);for(let l=0;l<n.length;l++)t[n[l]]=e;r(t)};let o=[],i=null,c=null;const s=e.imageData.entries();for(const[e,p]of s){const e=p.id;if(e in t){c=a[e],l&&null!==i&&c!=i&&(l=!1);const s=t[e],m=p;o.push(n.createElement("tr",null,n.createElement("td",null,n.createElement(u,{driveDuplicate:m,wagtailDuplicate:s})),n.createElement(d,{action:c,onClick:t=>{let n={...a};n[e]=t.target.value,r(n)}}))),i=c}}return n.createElement(n.Fragment,null,n.createElement("div",{class:"nice-padding"},n.createElement("h2",{class:"icon icon-warning"},"Duplicates detected"),n.createElement("p",null,"Wagtail has detected images similar to the ones you have just chosen to upload"),n.createElement("p",null,"Please choose how you would like to proceed"),n.createElement("p",null,n.createElement("b",null,Object.keys(t).length," duplicates detected")),n.createElement("table",{class:"listing"},n.createElement("thead",null,n.createElement("tr",{class:"table-headers"},n.createElement("th",null),n.createElement("th",null,"Replace original image"),n.createElement("th",null,"Keep both images"),n.createElement("th",null,"Cancel upload"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null),n.createElement(d,{action:getGlobalAction(),onClick:e=>{setGlobalAction(e.target.value)}})),o))),n.createElement("footer",null,n.createElement("ul",null,n.createElement("li",{class:"actions"},n.createElement("button",{type:"submit",class:"button",onClick:()=>e.onConfirmDuplicateActions(a)},"Confirm all")))))}return n.createElement("div",{class:"nice-padding"},n.createElement(m,{message:"Identifying duplicates"}))}function d(e){return n.createElement(n.Fragment,null,n.createElement("td",null,n.createElement("input",{type:"radio",value:"replace",checked:"replace"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"keep",checked:"keep"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"cancel",checked:"cancel"==e.action,onClick:e.onClick})))}function u(e){return n.createElement("table",{class:"image-comparison"},n.createElement("thead",null,n.createElement("tr",{class:"image-headings"},n.createElement("th",null,"Original"),n.createElement("th",null,"New"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null,n.createElement("img",{src:e.wagtailDuplicate.thumbnail,width:"165",height:"165"})),n.createElement("td",null,n.createElement("img",{src:e.driveDuplicate.thumbnailLink,width:"165",height:"165"}))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.wagtailDuplicate.title))),n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.driveDuplicate.name)))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,"Created at ",e.wagtailDuplicate.created_at)),n.createElement("td",null))))}function p(e){const[t,l]=n.useState(!1);function a(e,t,n){return e.type==google.picker.Type.PHOTO}function r(e,t,n){return e.type==google.picker.Type.jG}async function o(t){if(t.action==google.picker.Action.PICKED){const n=t.docs.filter(a),l=t.docs.filter(r);let o=new Array;if(l&&l.length){const e=`(mimeType contains 'image/') and (${l.reduce((e,t)=>e+`('${t.id}' in parents) or `,"").slice(0,-4)})`;let t=await gapi.client.drive.files.list({q:e,pageSize:1e3,fields:"nextPageToken, files(id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata, webContentLink)"});o.push(...t.result.files)}if(n&&n.length)for(let e=0;e<n.length;e++){let t=await gapi.client.drive.files.get({fileId:n[e].id,fields:"id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata, webContentLink"});o.push(t.result)}e.onGetImageData(o)}}return n.useEffect(()=>{gapi.load("client:auth2:picker",()=>{gapi.client.init({apiKey:e.pickerApiKey,clientId:e.clientId,discoveryDocs:["https://docs.googleapis.com/$discovery/rest?version=v1","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:e.scope}).then(()=>{l(!0)}).catch(e=>{console.error(e)})})},[]),t?n.createElement("div",{class:"nice-padding"},n.createElement("button",{class:"button bicolor icon icon-plus",onClick:function(){(function(){const t=gapi.auth2.getAuthInstance();return t.isSignedIn.get()?Promise.resolve(t.currentUser.get().getAuthResponse()):t.signIn({scope:e.scope}).then(e=>e.getAuthResponse())})().then(t=>function(t,n){let l=new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES);l.setSelectFolderEnabled(!0),l.setIncludeFolders(!0),l.setParent("root"),(new google.picker.PickerBuilder).setAppId(e.appId).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setDeveloperKey(e.pickerApiKey).setOAuthToken(t).addView(l).setCallback(n).build().setVisible(!0)}(t.access_token,o))}},"Select an image or folder in Drive")):n.createElement("div",{class:"nice-padding"},n.createElement(m,{message:"Loading Google API"}))}const m=e=>n.createElement("span",null,n.createElement(a,{name:"spinner",className:"c-spinner"}),e.message),g=document.querySelector("#importer");l.render(n.createElement(r,{appId:g.dataset.appId,pickerApiKey:g.dataset.pickerApiKey,clientId:g.dataset.clientId,duplicateReviewUrl:g.dataset.duplicateReviewUrl,csrfToken:document.querySelector("[name=csrfmiddlewaretoken]").value,collections:JSON.parse(g.dataset.collections),tagitOpts:{autocomplete:{source:g.dataset.autocompleteUrl}}}),g)}]);