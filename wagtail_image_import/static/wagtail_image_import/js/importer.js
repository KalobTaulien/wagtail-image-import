!function(e){var t={};function n(l){if(t[l])return t[l].exports;var a=t[l]={i:l,l:!1,exports:{}};return e[l].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,l){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:l})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var l=Object.create(null);if(n.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(l,a,function(t){return e[t]}.bind(null,a));return l},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t){const n=window.React,l=window.ReactDOM,a=window.wagtail.components.Icon;function c(e){const[t,l]=n.useState([]),[a,c]=n.useState(void 0);return t&&t.length?a?n.createElement("p",null,"Upload time!"):n.createElement(i,{imageData:t,duplicateReviewUrl:e.duplicateReviewUrl,onConfirmDuplicateActions:c}):n.createElement(s,{appId:e.appId,pickerApiKey:e.pickerApiKey,clientId:e.clientId,scope:"https://www.googleapis.com/auth/documents.readonly https://www.googleapis.com/auth/drive.readonly",onGetImageData:l})}function i(e){const[t,l]=n.useState({}),[a,c]=n.useState({});if(n.useEffect(()=>{const t=JSON.stringify(e.imageData);fetch(e.duplicateReviewUrl,{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:t}).then(t=>{t.ok?t.json().then(t=>{l(t);let n=Object.keys(t),a={};for(let e=0;e<n.length;e++)a[n[e]]="replace";c(a),0==n.length&&e.onConfirmDuplicateActions({})}):console.error(t)}).catch(e=>{console.error(e)})},[e.selectedImageData]),t&&Object.keys(t).length>0){let l=!0;getGlobalAction=()=>l?a[Object.keys(a)[0]]:null,setGlobalAction=e=>{let t={};const n=Object.keys(a);for(let l=0;l<n.length;l++)t[n[l]]=e;c(t)};let i=[],s=null,u=null;const d=e.imageData.entries();for(const[e,p]of d){const e=p.id;if(e in t){u=a[e],l&&null!==s&&u!=s&&(l=!1);const d=t[e],m=p;i.push(n.createElement("tr",null,n.createElement("td",null,n.createElement(o,{driveDuplicate:m,wagtailDuplicate:d})),n.createElement(r,{action:u,onClick:t=>{let n={...a};n[e]=t.target.value,c(n)}}))),s=u}}return n.createElement(n.Fragment,null,n.createElement("div",{class:"nice-padding"},n.createElement("h2",{class:"icon icon-warning"},"Duplicates detected"),n.createElement("p",null,"Wagtail has detected images similar to the ones you have just chosen to upload"),n.createElement("p",null,"Please choose how you would like to proceed"),n.createElement("p",null,n.createElement("b",null,Object.keys(t).length," duplicates detected")),n.createElement("table",{class:"listing"},n.createElement("thead",null,n.createElement("tr",{class:"table-headers"},n.createElement("th",null),n.createElement("th",null,"Replace original image"),n.createElement("th",null,"Keep both images"),n.createElement("th",null,"Cancel upload"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null),n.createElement(r,{action:getGlobalAction(),onClick:e=>{setGlobalAction(e.target.value)}})),i))),n.createElement("footer",null,n.createElement("ul",null,n.createElement("li",{class:"actions"},n.createElement("button",{type:"submit",class:"button",onClick:()=>e.onConfirmDuplicateActions(a)},"Confirm all")))))}return n.createElement("div",{class:"nice-padding"},n.createElement(u,{message:"Identifying duplicates"}))}function r(e){return n.createElement(n.Fragment,null,n.createElement("td",null,n.createElement("input",{type:"radio",value:"replace",checked:"replace"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"keep",checked:"keep"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"cancel",checked:"cancel"==e.action,onClick:e.onClick})))}function o(e){return n.createElement("table",{class:"image-comparison"},n.createElement("thead",null,n.createElement("tr",{class:"image-headings"},n.createElement("th",null,"Original"),n.createElement("th",null,"New"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null,n.createElement("img",{src:e.wagtailDuplicate.thumbnail,width:"165",height:"165"})),n.createElement("td",null,n.createElement("img",{src:e.driveDuplicate.thumbnailLink,width:"165",height:"165"}))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.wagtailDuplicate.title))),n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.driveDuplicate.name)))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,"Created at ",e.wagtailDuplicate.created_at)),n.createElement("td",null))))}function s(e){const[t,l]=n.useState(!1);function a(e,t,n){return e.type==google.picker.Type.PHOTO}function c(e,t,n){return e.type==google.picker.Type.jG}async function i(t){if(t.action==google.picker.Action.PICKED){const n=t.docs.filter(a),l=t.docs.filter(c);let i=new Array;if(l&&l.length){const e=`(mimeType contains 'image/') and (${l.reduce((e,t)=>e+`('${t.id}' in parents) or `,"").slice(0,-4)})`;let t=await gapi.client.drive.files.list({q:e,pageSize:1e3,fields:"nextPageToken, files(id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata)"});i.push(...t.result.files)}if(n&&n.length)for(let e=0;e<n.length;e++){let t=await gapi.client.drive.files.get({fileId:n[e].id,fields:"id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata"});i.push(t.result)}e.onGetImageData(i)}}return n.useEffect(()=>{gapi.load("client:auth2:picker",()=>{gapi.client.init({apiKey:e.pickerApiKey,clientId:e.clientId,discoveryDocs:["https://docs.googleapis.com/$discovery/rest?version=v1","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:e.scope}).then(()=>{l(!0)}).catch(e=>{console.error(e)})})},[]),t?n.createElement("div",{class:"nice-padding"},n.createElement("button",{class:"button bicolor icon icon-plus",onClick:function(){(function(){const t=gapi.auth2.getAuthInstance();return t.isSignedIn.get()?Promise.resolve(t.currentUser.get().getAuthResponse()):t.signIn({scope:e.scope}).then(e=>e.getAuthResponse())})().then(t=>function(t,n){let l=new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES);l.setSelectFolderEnabled(!0),l.setIncludeFolders(!0),l.setParent("root"),(new google.picker.PickerBuilder).setAppId(e.appId).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setDeveloperKey(e.pickerApiKey).setOAuthToken(t).addView(l).setCallback(n).build().setVisible(!0)}(t.access_token,i))}},"Select an image or folder in Drive")):n.createElement("div",{class:"nice-padding"},n.createElement(u,{message:"Loading Google API"}))}const u=e=>n.createElement("span",null,n.createElement(a,{name:"spinner",className:"c-spinner"}),e.message),d=document.querySelector("#importer");l.render(n.createElement(c,{appId:d.dataset.appId,pickerApiKey:d.dataset.pickerApiKey,clientId:d.dataset.clientId,duplicateReviewUrl:d.dataset.duplicateReviewUrl}),d)}]);