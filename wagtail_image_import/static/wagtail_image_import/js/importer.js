!function(e){var t={};function n(a){if(t[a])return t[a].exports;var l=t[a]={i:a,l:!1,exports:{}};return e[a].call(l.exports,l,l.exports,n),l.l=!0,l.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var l in e)n.d(a,l,function(t){return e[t]}.bind(null,l));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t){const n=window.React,a=window.ReactDOM,l=window.wagtail.components.Icon;function r(e){const[t,a]=n.useState([]),[l,r]=n.useState(void 0),[o,s]=n.useState(void 0);return t&&t.length?l?n.createElement(i,{imageImports:t.map(e=>{const t=e.id;return l[t],imageImport={drive_id:t,name:e.name,progress:0,action:l[t]||"keep",thumbnail:e.thumbnailLink,wagtail_id:"replace"==l[t]?o[t].wagtail_id:null}}).filter(e=>!("cancel"==e.action)),csrfToken:e.csrfToken}):n.createElement(c,{imageData:t,duplicateReviewUrl:e.duplicateReviewUrl,onConfirmDuplicateActions:r,onGetDuplicateData:s}):n.createElement(u,{appId:e.appId,pickerApiKey:e.pickerApiKey,clientId:e.clientId,scope:"https://www.googleapis.com/auth/documents.readonly https://www.googleapis.com/auth/drive.readonly",onGetImageData:a})}function i(e){const[t,a]=n.useState(!1),[l,r]=n.useState(e.imageImports),i=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;function c(e,t,n){let a=[...l];a[n][e]=t,r(a)}function s(t,n){a(!0);var l=new XMLHttpRequest;l.addEventListener("load",r=>{c("progress",50,n),function(t,n,l){let r=new FormData;r.append("drive_id",n.drive_id),r.append("wagtail_id",n.wagtail_id),r.append("action",n.action),r.append("name",n.name),r.append("collection",1),r.append("image_file",t);var i=new XMLHttpRequest;i.addEventListener("load",async e=>{a(!1);let t=await i.response;t=JSON.parse(t),t.error&&c("error",t.error,l),c("imported",!0,l),c("form",t.form,l),c("edit_action",t.edit_action,l),c("delete_action",t.delete_action,l),c("progress",100,l)}),i.addEventListener("error",async e=>{a(!1),c("error","Failed to upload to Wagtail",l)}),i.upload.addEventListener("progress",e=>{e.lengthComputable&&c("progress",Math.floor(50+100*e.loaded/(2*e.total)),l)}),i.open("POST",window.location),i.setRequestHeader("X-CSRFToken",e.csrfToken),i.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest"),i.send(r)}(new File([l.response],t.name),t,n)}),l.addEventListener("error",()=>{c("progress",0,n),a(!1),c("error","Failed to import from Google",n)}),l.addEventListener("progress",e=>{e.lengthComputable&&c("progress",Math.floor(100*e.loaded/(2*e.total)),n)}),l.open("GET","https://www.googleapis.com/drive/v3/files/"+t.drive_id+"?alt=media"),l.responseType="blob",l.setRequestHeader("Authorization","Bearer "+i),l.send()}return n.useEffect(()=>{if(!t){const e=l.findIndex(e=>!e.error&&!e.imported),t=l[e];t&&s(t,e)}},[t]),n.createElement("ul",{id:"upload-list",class:"upload-list multiple"},l.filter(e=>!e.finished).map((function(t,a){return n.createElement(o,{progress:t.progress,thumbnail:t.thumbnail,name:t.name,form:t.form,error:t.error,onFormResponseError:e=>{c("error",e.error,a),c("form",e.form,a),c("edit_action",e.edit_action,a),c("delete_action",e.delete_action,a)},onFormResponseSuccess:e=>{c("finished",!0,a),c("error",e.error,a),c("form",e.form,a),c("edit_action",e.edit_action,a),c("delete_action",e.delete_action,a)},onDeleteResponseLoad:e=>{c("finished",!0,a),c("error",e.error,a),c("form",e.form,a),c("edit_action",e.edit_action,a),c("delete_action",e.delete_action,a)},driveId:t.drive_id,editAction:t.edit_action,deleteAction:t.delete_action,csrfToken:e.csrfToken})})))}function o(e){return n.createElement("li",{class:"row upload-uploading"},n.createElement("div",{class:"left col3"},n.createElement("div",{class:"preview"},n.createElement("div",{class:"thumb icon icon-image hasthumb"},n.createElement("img",{src:e.thumbnail})),n.createElement("div",{class:"progress active"},n.createElement("div",{class:"bar",style:{width:e.progress+"%"}},e.progress,"%")))),n.createElement("div",{class:"right col9"},n.createElement("p",null,e.name),e.error,n.createElement("form",{method:"POST",enctype:"multipart/form-data",novalidate:!0,onSubmit:t=>{t.preventDefault();var n=new XMLHttpRequest;n.addEventListener("load",async t=>{t.preventDefault(),res=await n.response,res=JSON.parse(res),res.error?e.onFormResponseError(res):e.onFormResponseSuccess(res)}),n.open("POST",e.editAction),n.setRequestHeader("X-CSRFToken",e.csrfToken),n.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest"),n.send(new FormData(t.target))}},n.createElement("ul",{class:"fields"},n.createElement("div",{dangerouslySetInnerHTML:{__html:e.form}}),n.createElement("li",null,n.createElement("input",{type:"hidden",name:"drive_id",value:e.driveId}),n.createElement("input",{type:"submit",value:"Update",class:"button"}),n.createElement("button",{class:"delete button button-secondary no",onClick:t=>{t.preventDefault();var n=new XMLHttpRequest;n.addEventListener("load",async t=>{t.preventDefault(),res=await n.response,res=JSON.parse(res),e.onDeleteResponseLoad(res)}),n.open("POST",e.editAction),n.setRequestHeader("X-CSRFToken",e.csrfToken),n.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest"),n.send()}},'"Delete"'))))))}function c(e){const[t,a]=n.useState({}),[l,r]=n.useState({});if(n.useEffect(()=>{const t=JSON.stringify(e.imageData);fetch(e.duplicateReviewUrl,{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:t}).then(t=>{t.ok?t.json().then(t=>{a(t),e.onGetDuplicateData(t);let n=Object.keys(t),l={};for(let e=0;e<n.length;e++)l[n[e]]="replace";r(l),0==n.length&&e.onConfirmDuplicateActions({})}):console.error(t)}).catch(e=>{console.error(e)})},[e.selectedImageData]),t&&Object.keys(t).length>0){let a=!0;getGlobalAction=()=>a?l[Object.keys(l)[0]]:null,setGlobalAction=e=>{let t={};const n=Object.keys(l);for(let a=0;a<n.length;a++)t[n[a]]=e;r(t)};let i=[],o=null,c=null;const u=e.imageData.entries();for(const[e,p]of u){const e=p.id;if(e in t){c=l[e],a&&null!==o&&c!=o&&(a=!1);const u=t[e],m=p;i.push(n.createElement("tr",null,n.createElement("td",null,n.createElement(d,{driveDuplicate:m,wagtailDuplicate:u})),n.createElement(s,{action:c,onClick:t=>{let n={...l};n[e]=t.target.value,r(n)}}))),o=c}}return n.createElement(n.Fragment,null,n.createElement("div",{class:"nice-padding"},n.createElement("h2",{class:"icon icon-warning"},"Duplicates detected"),n.createElement("p",null,"Wagtail has detected images similar to the ones you have just chosen to upload"),n.createElement("p",null,"Please choose how you would like to proceed"),n.createElement("p",null,n.createElement("b",null,Object.keys(t).length," duplicates detected")),n.createElement("table",{class:"listing"},n.createElement("thead",null,n.createElement("tr",{class:"table-headers"},n.createElement("th",null),n.createElement("th",null,"Replace original image"),n.createElement("th",null,"Keep both images"),n.createElement("th",null,"Cancel upload"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null),n.createElement(s,{action:getGlobalAction(),onClick:e=>{setGlobalAction(e.target.value)}})),i))),n.createElement("footer",null,n.createElement("ul",null,n.createElement("li",{class:"actions"},n.createElement("button",{type:"submit",class:"button",onClick:()=>e.onConfirmDuplicateActions(l)},"Confirm all")))))}return n.createElement("div",{class:"nice-padding"},n.createElement(p,{message:"Identifying duplicates"}))}function s(e){return n.createElement(n.Fragment,null,n.createElement("td",null,n.createElement("input",{type:"radio",value:"replace",checked:"replace"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"keep",checked:"keep"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"cancel",checked:"cancel"==e.action,onClick:e.onClick})))}function d(e){return n.createElement("table",{class:"image-comparison"},n.createElement("thead",null,n.createElement("tr",{class:"image-headings"},n.createElement("th",null,"Original"),n.createElement("th",null,"New"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null,n.createElement("img",{src:e.wagtailDuplicate.thumbnail,width:"165",height:"165"})),n.createElement("td",null,n.createElement("img",{src:e.driveDuplicate.thumbnailLink,width:"165",height:"165"}))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.wagtailDuplicate.title))),n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.driveDuplicate.name)))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,"Created at ",e.wagtailDuplicate.created_at)),n.createElement("td",null))))}function u(e){const[t,a]=n.useState(!1);function l(e,t,n){return e.type==google.picker.Type.PHOTO}function r(e,t,n){return e.type==google.picker.Type.jG}async function i(t){if(t.action==google.picker.Action.PICKED){const n=t.docs.filter(l),a=t.docs.filter(r);let i=new Array;if(a&&a.length){const e=`(mimeType contains 'image/') and (${a.reduce((e,t)=>e+`('${t.id}' in parents) or `,"").slice(0,-4)})`;let t=await gapi.client.drive.files.list({q:e,pageSize:1e3,fields:"nextPageToken, files(id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata, webContentLink)"});i.push(...t.result.files)}if(n&&n.length)for(let e=0;e<n.length;e++){let t=await gapi.client.drive.files.get({fileId:n[e].id,fields:"id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata, webContentLink"});i.push(t.result)}e.onGetImageData(i)}}return n.useEffect(()=>{gapi.load("client:auth2:picker",()=>{gapi.client.init({apiKey:e.pickerApiKey,clientId:e.clientId,discoveryDocs:["https://docs.googleapis.com/$discovery/rest?version=v1","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:e.scope}).then(()=>{a(!0)}).catch(e=>{console.error(e)})})},[]),t?n.createElement("div",{class:"nice-padding"},n.createElement("button",{class:"button bicolor icon icon-plus",onClick:function(){(function(){const t=gapi.auth2.getAuthInstance();return t.isSignedIn.get()?Promise.resolve(t.currentUser.get().getAuthResponse()):t.signIn({scope:e.scope}).then(e=>e.getAuthResponse())})().then(t=>function(t,n){let a=new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES);a.setSelectFolderEnabled(!0),a.setIncludeFolders(!0),a.setParent("root"),(new google.picker.PickerBuilder).setAppId(e.appId).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setDeveloperKey(e.pickerApiKey).setOAuthToken(t).addView(a).setCallback(n).build().setVisible(!0)}(t.access_token,i))}},"Select an image or folder in Drive")):n.createElement("div",{class:"nice-padding"},n.createElement(p,{message:"Loading Google API"}))}const p=e=>n.createElement("span",null,n.createElement(l,{name:"spinner",className:"c-spinner"}),e.message),m=document.querySelector("#importer");a.render(n.createElement(r,{appId:m.dataset.appId,pickerApiKey:m.dataset.pickerApiKey,clientId:m.dataset.clientId,duplicateReviewUrl:m.dataset.duplicateReviewUrl,csrfToken:document.querySelector("[name=csrfmiddlewaretoken]").value}),m)}]);